在 CentOS 7 安b Nginx、PHP-FPM、MariaDB
时间 2015-05-08 17:44:00  XYZ的P本
原文  http://xyz.cinc.biz/2015/05/centos7-install-nginx-php-fpm-mariadb.html
主题 Nginx MariaDB Centos
安b nginx 
CentOS 7 ]有冉ǖ nginx，所以先到 nginx 官W  http://nginx.org/en/linux_packages.html#stable ，找到 CentOS 7 的 nginx-release package n案BY，然後如下安b
rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
安b後，自赢a生 yum 的 repository O定(在 /etc/yum.repos.d/nginx.repo)， 
接下肀憧梢允褂 yum 指令安b nginx
yum install nginx
 nginx 
以前用 chkconfig 管理服眨CentOS 7 改用 systemctl 管理系y服 
立即
systemctl start nginx
查看目前\作B
systemctl status nginx
查看 nginx 服漳壳暗釉O定
systemctl list-unit-files | grep nginx
若是 disabled，可以改成_C自
systemctl enable nginx
若有O定防火，查看防火\行B，看是否有_ nginx 使用的 port
firewall-cmd --state
永久_放_⒎阑的 http 服
firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --reload
列出防火 public 的O定
firewall-cmd --list-all --zone=public
^以上O定，就可以使用g[器L nginx 的AO面。
安b PHP-FPM 
使用 yum 安b php、php-fpm、php-mysql
yum install php php-fpm php-mysql
查看 php-fpm 服漳壳暗釉O定 
systemctl list-unit-files | grep php-fpm
改成_C自
systemctl enable php-fpm
立即
systemctl start php-fpm
查看目前\作B
systemctl status php-fpm
修改 PHP-FPM listen 的方式 
若想 PHP-FPM listen 的方式，改成 unix socket，可以 /etc/php-fpm.d/www.conf 

listen = 127.0.0.1:9000
改成
listen = /var/run/php-fpm/php-fpm.sock
然後重新 php-fpm
systemctl restart php-fpm
]：不要改成 listen = /tmp/php-fcgi.sock ( php-fcgi.sock O定在 /tmp 底下)， 因橄到ya生 php-fcgi.sock r，放在 /tmp/systemd-private-*/tmp/php-fpm.sock SC私有目下， 除非把 /usr/lib/systemd/system/ e面的 PrivateTmp=true O定改成 PrivateTmp=false， 但是a生其他}，所以是Q位置最方便 
相PY料： 
Centos 7 systemd temp files 
Why can't I see /tmp content with Php-FPM?  
在 nginx O定使用 PHP-FPM 
 /etc/nginx/conf.d/default.conf n案，但@要注意，O定n中AO例，PHP]解部分似乎有些e`，若只拿掉]解可能是o法正常\作，我⒅攸c部分改成如下
server {
	listen 80;
	server_name www.example.com;
	location / {
		index index.php index.html index.htm;
		root  /home/web;
	}
	# O定 PHP n案理方式
	location ~ \.php$ {
		root  /home/web;
		try_files $uri =404;
		fastcgi_pass  unix:/var/run/php-fpm/php-fpm.sock;
		fastcgi_index index.php;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		include fastcgi_params;
	}
}
其他：系y原本AO的W目在 /usr/share/nginx/html，如果像我⒕W目 root 改到其他地方，例如 /home/web，加上系y的 SELinux 是_⒌牡脑，很可能因 SELinux，而o法正常L。 
如果不P掉 SELinux，可以查看 /usr/share/nginx/html 目的 SELinux 存取O定
ls -Zd /usr/share/nginx/html
drwxr-xr-x. root root system_u:object_r:usr_t:s0       /usr/share/nginx/html
然後 /home/web O成跟AO存取嘞抟
chcon -R -u system_u -r object_r -t usr_t /home/web
再重新 nginx
systemctl restart nginx
安b MariaDB 
CentOS7 e面已用 MariaDB 取代 MySQL， 
所以使用 yum install mariadb 或 yum install mysql，最後都是安b MariaDB
yum install mariadb mariadb-server
查看 php-fpm 服漳壳暗釉O定 
systemctl list-unit-files | grep php-fpm
改成_C自 
systemctl enable mariadb
立即 
systemctl start mariadb
若要其他X也可B 
O定n中不要O定 bind-address
#bind-address = 127.0.0.1
_⒎阑O定 
firewall-cmd --permanent --zone=public --add-service=mysql
firewall-cmd --reload
使用 mysql_secure_installation M行安全的相PO定 
mysql_secure_installation 指令，一步一步以答方式M行 MySQL 的安全性O定(O定 root 密a、移除 root 可以钠渌X登入的O定、移除匿名ぬ、移除 test Y料)。 
mysql_secure_installation
因槭切掳惭b的，]有密a，所以要 Enter current password for root r留空白，直接按 enter 
O定^程如下 
Enter current password for root (enter for none):
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y/n] Y
New password:
Re-enter new password:
Password updated successfully!
Reloading privilege tables..
 ... Success!

 
By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] Y
 ... Success!

Normally, root should only be allowed to connect from 'localhost'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
 ... Success!

By default, MariaDB comes with a database named 'test' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] Y
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] Y
 ... Success!

Cleaning up...

All done!  If you've completed all of the above steps, your MariaDB
installation should now be secure.

Thanks for using MariaDB!
其他：

h除所有 php-fpm 程序
killall -KILL php-fpm
PHP-FPM - Kill all linux processes that belong to php-fpm - one command line 
PHP FPMO定⒖
[global]
pid = /usr/local/php/var/run/php-fpm.pid
error_log = /usr/local/php/var/log/php-fpm.log
[www]
listen = /var/run/php-fpm/php-fpm.sock
user = www
group = www
pm = dynamic
pm.max_children = 800
pm.start_servers = 200
pm.min_spare_servers = 100
pm.max_spare_servers = 800
pm.max_requests = 4000
rlimit_files = 51200

listen.backlog = 65536
;O 65536 的原因是-1 可能不是unlimited
;f明 http://php.net/manual/en/install.fpm.configuration.php#104172

slowlog = /usr/local/php/var/log/slow.log
request_slowlog_timeout = 10
nginx.conf O定⒖ 
user  nginx;
worker_processes  8;
error_log  /var/log/nginx/error.log warn;
pid		/var/run/nginx.pid;
events {
	use epoll;
	worker_connections  65535;
}
worker_rlimit_nofile 65535;
#若]O定，可能出Fe`:65535 worker_connections exceed open file resource limit: 1024
http {
	include	   /etc/nginx/mime.types;
	default_type  application/octet-stream;
	log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
					  '$status $body_bytes_sent "$http_referer" '
					  '"$http_user_agent" "$http_x_forwarded_for"';
	access_log  /var/log/nginx/access.log  main;
	sendfile		on;
	tcp_nopush	 on;
	keepalive_timeout  65;
	server_names_hash_bucket_size 128;
	client_header_buffer_size 32k;
	large_client_header_buffers 4 32k;
	client_max_body_size 8m;
	server_tokens  off;
	client_body_buffer_size  512k;
	# fastcgi
	fastcgi_connect_timeout 300;
	fastcgi_send_timeout 300;
	fastcgi_read_timeout 300;
	fastcgi_buffer_size 64k;
	fastcgi_buffers 4 64k;
	fastcgi_busy_buffers_size 128k;
	fastcgi_temp_file_write_size 128k;
	fastcgi_intercept_errors on;
	#gzip (f明 http://nginx.org/en/docs/http/ngx_http_gzip_module.html)
	gzip  off;
	gzip_min_length  1k;#1k以上才嚎s
	gzip_buffers 32  4k;
	  #http://stackoverflow.com/questions/4888067/how-to-get-linux-kernel-page-size-programatically
	  #使用 getconf PAGESIZE 取得系y one memory page size，
	gzip_http_version  1.0;
	gzip_comp_level  2;
	gzip_types  text/css text/xml application/javascript application/atom+xml application/rss+xml text/plain application/json;
	  #查看 nginx 的 mime.types n案(/etc/nginx/mime.types),e面有各N型的定x
	gzip_vary  on;
	include /etc/nginx/conf.d/*.conf;
}
若出F出Fe`:setrlimit(RLIMIT_NOFILE, 65535) failed (1: Operation not permitted) 
先查看目前系y的O定值
ulimit -n
若O定值太小，修改 /etc/security/limits.conf
vi /etc/security/limits.conf
加上或修改以下尚性O定
* soft nofile 65535
* hard nofile 65535